<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer (Vue.js)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf.js Library (v3.11.174) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* スムーズなビュー切り替えのための簡単なトランジション（任意） */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="m-0 p-0 overflow-hidden">

    <div id="app" class="min-h-screen">

        <!-- トップメニュー画面 (Vue) -->
        <transition name="fade">
            <div v-if="currentView === 'menu'"
                class="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-8"
                @drop.prevent="handleDrop" @dragover.prevent="handleDragOver">

                <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">PDF Viewer (Vue.js)</h1>
                    <div class="space-y-4">
                        <label for="file-input" class="block">
                            <div
                                class="border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-blue-500 transition-colors cursor-pointer">
                                <div class="text-gray-500 mb-2">
                                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                        </path>
                                    </svg>
                                </div>
                                <p class="text-lg font-medium text-gray-700">PDFファイルを選択</p>
                                <p class="text-sm text-gray-500 mt-1">またはドラッグ＆ドロップ</p>
                            </div>
                            <input type="file" id="file-input" accept="application/pdf" class="hidden"
                                @change="handleFileChange">
                        </label>
                    </div>
                </div>

                <!-- メニュー画面用のステータスメッセージ -->
                <div v-if="isLoading && statusText"
                    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-gray-500 bg-white px-4 py-2 rounded-lg shadow-lg">
                    {{ statusText }}
                </div>
            </div>
        </transition>

        <!-- PDFビュー画面 (Vue) -->
        <transition name="fade">
            <div v-if="currentView === 'pdf'" class="min-h-screen bg-gray-100">
                <!-- 戻るボタン -->
                <button @click="goBackToMenu"
                    class="fixed top-4 left-4 z-50 bg-white hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-lg transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    戻る
                </button>

                <!-- PDF表示エリア -->
                <div ref="pdfContainerRef"
                    class="fixed top-0 left-0 w-screen h-screen bg-gray-100 overflow-y-auto overflow-x-hidden">
                    <!-- Canvasはここに動的に挿入されます -->
                    <div ref="pdfPagesRef" class="flex flex-col items-center py-8"></div>
                </div>

                <!-- ページ番号表示 -->
                <div v-if="!isLoading && totalPages > 0"
                    class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-white/90 px-4 py-2 rounded-lg shadow-lg z-10">
                    <span class="text-gray-700 font-medium text-sm">
                        ページ: <span id="page-num">{{ currentPageNum }}</span> / <span id="page-count">{{ totalPages
                            }}</span>
                    </span>
                </div>

                <!-- ローディング・エラー表示 -->
                <div v-if="isLoading"
                    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-gray-500 bg-white px-4 py-2 rounded-lg shadow-lg z-20">
                    {{ statusText }}
                </div>
            </div>
        </transition>

    </div>

    <script>
        // VueからshallowRefをインポート
        const { createApp, ref, shallowRef, onMounted, onUnmounted, nextTick } = Vue;

        createApp({
            setup() {
                // pdf.js のワーカーパスを設定
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                if (pdfjsLib) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                // --- リアクティブな状態定義 (State) ---
                const currentView = ref('menu'); // 'menu' または 'pdf'
                // pdfDoc を ref から shallowRef に変更
                // これにより、pdfDoc.value に代入されたオブジェクトの内部まで
                // Vueがリアクティブ（プロキシ化）しようとするのを防ぎます。
                const pdfDoc = shallowRef(null);
                const currentPageNum = ref(0);
                const totalPages = ref(0);
                const pageHeights = ref([]);
                const statusText = ref('');
                const isLoading = ref(false);
                let currentScale = 1.0; // PDFの表示倍率

                // --- DOM要素への参照 (Refs) ---
                const pdfContainerRef = ref(null); // PDFスクロールコンテナ
                const pdfPagesRef = ref(null);     // PDFページ(Canvas)のラッパー

                // --- メソッド (Methods) ---

                /**
                 * 最初のページに基づいて最適なスケールを計算する
                 * (全ページで同じスケールを適用するため)
                 * @param {Object} page - PDFページオブジェクト
                 */
                function calculateOptimalScale(page) {
                    const container = pdfContainerRef.value;
                    if (!container) return 1.0;

                    // コンテナの幅からパディング分（左右20pxずつなど）を引く
                    const containerWidth = container.clientWidth - 40;
                    const viewport = page.getViewport({ scale: 1.0 });

                    // 幅基準でスケールを計算
                    const scale = containerWidth / viewport.width;

                    // スケールが大きくなりすぎないように制限 (最大2倍)
                    return Math.min(scale, 2.0);
                }

                /**
                 * すべてのページを連続してレンダリングする
                 */
                async function renderAllPages() {
                    // pdfDoc.value は shallowRef でも同じようにアクセスできます
                    if (!pdfDoc.value) return;

                    isLoading.value = true;
                    statusText.value = 'PDFを読み込み中...';

                    // DOM要素が利用可能になるのを待つ
                    await nextTick();

                    const container = pdfPagesRef.value;
                    if (!container) {
                        console.error("pdfPagesRef が見つかりません。");
                        isLoading.value = false;
                        return;
                    }

                    try {
                        // 既存のページ(Canvas)をクリア
                        container.innerHTML = '';
                        const newPageHeights = [];

                        // 最初のページを取得してスケールを決定
                        // pdfDoc.value.getPage は、プロキシ化されていない
                        // オリジナルの pdf.js オブジェクトのメソッドを呼び出すため
                        // エラーが解消されるはずです。
                        const firstPage = await pdfDoc.value.getPage(1);
                        currentScale = calculateOptimalScale(firstPage);

                        // 各ページを順番にレンダリング
                        for (let pageNum = 1; pageNum <= pdfDoc.value.numPages; pageNum++) {
                            statusText.value = `${pageNum}/${totalPages.value}ページ目を読み込み中...`;

                            const page = await pdfDoc.value.getPage(pageNum);
                            const viewport = page.getViewport({ scale: currentScale });

                            // Canvas要素を作成
                            const canvas = document.createElement('canvas');
                            canvas.className = 'shadow-lg rounded-lg mb-4';
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const canvasContext = canvas.getContext('2d');

                            // レンダリング設定
                            const renderContext = {
                                canvasContext: canvasContext,
                                viewport: viewport
                            };

                            // レンダリングを実行
                            await page.render(renderContext).promise;

                            // DOMに追加
                            container.appendChild(canvas);
                            // ページの高さを保存（スクロール追跡用）
                            newPageHeights.push(viewport.height);
                        }

                        // リアクティブ変数を更新
                        pageHeights.value = newPageHeights;
                        isLoading.value = false;
                        statusText.value = '';
                        currentPageNum.value = 1; // 最初のページ番号を設定

                        // スクロールイベントリスナーを設定
                        if (pdfContainerRef.value) {
                            pdfContainerRef.value.addEventListener('scroll', updateCurrentPageFromScroll);
                        }

                    } catch (error) {
                        // ここでエラーがキャッチされる
                        console.error('ページのレンダリングに失敗:', error);
                        statusText.value = `PDFのレンダリングエラー: ${error.message}`;
                        isLoading.value = false;
                    }
                }

                /**
                 * スクロール位置に基づいて現在のページ番号を更新する
                 */
                function updateCurrentPageFromScroll() {
                    const container = pdfContainerRef.value;
                    if (!container || pageHeights.value.length === 0) return;

                    const scrollTop = container.scrollTop;
                    const containerHeight = container.clientHeight;
                    // 画面の中央のスクロール位置
                    const scrollCenter = scrollTop + containerHeight / 2;

                    let accumulatedHeight = 0; // ページ上端までの累積高さ
                    let currentPage = 1;

                    for (let i = 0; i < pageHeights.value.length; i++) {
                        const pageTop = accumulatedHeight;
                        // ページ下端 = ページ上端 + ページ高さ + マージン(mb-4 = 1rem = 16px)
                        const pageBottom = pageTop + pageHeights.value[i] + 16;

                        // 画面中央がこのページの範囲内にあるか
                        if (scrollCenter >= pageTop && scrollCenter < pageBottom) {
                            currentPage = i + 1;
                            break;
                        }

                        // 最後のページの場合のチェック
                        if (i === pageHeights.value.length - 1 && scrollCenter >= pageBottom) {
                            currentPage = pageHeights.value.length;
                            break;
                        }

                        accumulatedHeight = pageBottom;
                    }

                    currentPageNum.value = currentPage;
                }

                /**
                 * PDFファイルをロードして表示する
                 * @param {File} file - 選択されたPDFファイル
                 */
                async function loadPdf(file) {
                    const fileReader = new FileReader();

                    fileReader.onload = async function () {
                        const typedarray = new Uint8Array(this.result);
                        isLoading.value = true;
                        statusText.value = 'PDFを読み込み中...';

                        try {
                            // PDFドキュメントを非同期でロード
                            const loadingTask = pdfjsLib.getDocument(typedarray);
                            // pdfDoc.value には、pdf.js から返された生のオブジェクトが格納されます
                            pdfDoc.value = await loadingTask.promise;

                            totalPages.value = pdfDoc.value.numPages;

                            // PDFビューに切り替え
                            currentView.value = 'pdf';

                            // ページレンダリングを開始
                            // (currentViewが'pdf'に切り替わり、DOMが描画された後に実行される)
                            await renderAllPages();

                        } catch (error) {
                            console.error('PDFの読み込みに失敗:', error);
                            statusText.value = `PDFの読み込みエラー: ${error.message}`;
                            isLoading.value = false;
                            // エラーが起きてもメニュー画面に戻さない（エラーメッセージを表示するため）
                            // メニューに戻したい場合は goBackToMenu() を呼ぶ
                        }
                    };

                    fileReader.readAsArrayBuffer(file);
                }

                // --- イベントハンドラ ---

                /**
                 * ファイル入力が変更された時のハンドラ
                 */
                function handleFileChange(e) {
                    const file = e.target.files[0];
                    handleFile(file);
                }

                /**
                 * ファイルがドロップされた時のハンドラ
                 */
                function handleDrop(e) {
                    const file = e.dataTransfer.files[0];
                    handleFile(file);
                }

                /**
                 * ファイル処理の共通ロジック
                 */
                function handleFile(file) {
                    if (file && file.type === 'application/pdf') {
                        loadPdf(file);
                    } else if (file) {
                        statusText.value = 'PDFファイルを選択してください。';
                        isLoading.value = true; // メッセージを一時的に表示
                        setTimeout(() => {
                            isLoading.value = false;
                            statusText.value = '';
                        }, 2000);
                    }
                }

                /**
                 * ドラッグオーバーイベントのデフォルト動作をキャンセル
                 */
                function handleDragOver(e) {
                    // デフォルト動作（ファイルを開くなど）を防ぐ
                    e.preventDefault();
                }

                /**
                 * メニュー画面に戻る
                 */
                function goBackToMenu() {
                    // 状態をリセット
                    pdfDoc.value = null;
                    pageHeights.value = [];
                    totalPages.value = 0;
                    currentPageNum.value = 0;
                    isLoading.value = false;
                    statusText.value = '';

                    // スクロールイベントリスナーを削除
                    if (pdfContainerRef.value) {
                        pdfContainerRef.value.removeEventListener('scroll', updateCurrentPageFromScroll);
                    }

                    // 動的に追加したCanvasをクリア
                    if (pdfPagesRef.value) {
                        pdfPagesRef.value.innerHTML = '';
                    }

                    // メニュービューに切り替え
                    currentView.value = 'menu';
                }

                /**
                 * ウィンドウリサイズ時の処理
                 */
                function handleResize() {
                    // PDFビューが表示されている時のみ再レンダリング
                    if (currentView.value === 'pdf' && pdfDoc.value) {
                        renderAllPages();
                    }
                }

                // --- ライフサイクルフック ---

                onMounted(() => {
                    // リサイズイベントリスナーを登録
                    window.addEventListener('resize', handleResize);
                });

                onUnmounted(() => {
                    // リサイズイベントリスナーを解除
                    window.removeEventListener('resize', handleResize);

                    // コンポーネント破棄時にスクロールリスナーも解除
                    if (pdfContainerRef.value) {
                        pdfContainerRef.value.removeEventListener('scroll', updateCurrentPageFromScroll);
                    }
                });

                // --- setup() から返す ---
                return {
                    currentView,
                    currentPageNum,
                    totalPages,
                    statusText,
                    isLoading,

                    pdfContainerRef,
                    pdfPagesRef,

                    handleFileChange,
                    handleDrop,
                    handleDragOver,
                    goBackToMenu,
                };
            }
        }).mount('#app');
    </script>

</body>

</html>